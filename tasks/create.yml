---
- name: Installation des packages lxc
  apt:
    name: "{{ item }}"
    state: latest
  with_items:
    - lxc
    - lxc-dev
    - yum
  tags:
    - create

- name: Installation des bindings python pour lxc
  pip:
    name: "{{ item }}"
    state: latest
  with_items:
    - lxc-python2
    - jmespath
  tags:
    - create

- name: Création des containers
  lxc_container:
    name: "{{ item.name }}"
    container_log: true
    template: "{{ item.template }}"
    state: started
    template_options: "--release {{ item.release }}"
  with_items: "{{ lxc_deploy_containers }}"
  register: add_lxc_container
  tags:
    - create

- name: Ajout des lignes de configuration supplémentaires
  lineinfile:
    dest: "/var/lib/lxc/{{ item.0.name }}/config"
    line: "{{ item.1 }}"
  with_subelements:
    - "{{ lxc_deploy_containers }}"
    - extra_conf
    - flags:
      skip_missing: True
  register: add_lxc_config
  tags:
    - create

- name: Restart du container si des configurations supplémentaires ont été ajoutées
  lxc_container:
    name: "{{ item.name }}"
    state: restarted
  with_items: "{{ add_lxc_config.results | json_query(query) | unique }}"
  when: item.changed == True
  vars:
    query: "[*].{changed: changed, name: item[0].name}"
  tags:
    - create

- name: Installation de python sur les containers
  lxc_container:
    name: "{{ item.name }}"
    container_command: |
      {{ item.pkg_mgr }} update -y
      {{ item.pkg_mgr }} install -y python sudo
  with_items: "{{ add_lxc_container | json_query(query) }}"
  when: item.changed == True
  vars:
    query: "results[*].{changed: changed, name: item.name, pkg_mgr: item.pkg_mgr}"
  tags:
    - create
